# Port Migration: 3000→4300 & 8000→4400

**Date**: 2025-10-30
**Scope**: Complete port migration for GraphRAG monorepo
**Changes**: Frontend 3000→4300, Backend 8000→4400

## Investigation Summary

### Initial Search
Used `Grep` tool to find all port references:
- Pattern: `:3000|port.*3000|3000` found 41 occurrences
- Pattern: `:8000|port.*8000|8000` found 73 occurrences
- Filtered false positives (timestamps like 30000ms, package versions)

### Key Findings by Category

#### 1. Backend Configuration
**File**: `apps/api/app/main.py:64`
```python
# CHANGED: port=8000 → port=4400
uvicorn.run("app.main:app", host="0.0.0.0", port=4400, reload=True)
```

**File**: `apps/api/app/core/config.py:26-29,52`
```python
# CORS origins updated
CORS_ORIGINS: List[str] = [
    "http://localhost:4300",  # was 3000
    "http://localhost:4301",  # was 3001
    "http://10.1.0.6:4300",   # was 3000
    "http://10.1.0.6:4301",   # was 3001
]

# Webhook URL updated
WEBHOOK_BASE_URL: str = "http://localhost:4400"  # was 8000
```

#### 2. Frontend Configuration
**File**: `apps/web/package.json:6`
```json
{
  "scripts": {
    "dev": "next dev -p 4300"  // Added -p flag
  }
}
```

**File**: `apps/web/.env.example:3,7`
```bash
NEXT_PUBLIC_API_URL=http://localhost:4400  # was 8000
NEXT_PUBLIC_APP_URL=http://localhost:4300  # was 3000
```

**File**: `apps/web/.env.local`
```bash
# Added new configuration
NEXT_PUBLIC_API_URL=http://localhost:4400
NEXT_PUBLIC_APP_URL=http://localhost:4300
```

#### 3. API Routes (12 files)
**Pattern**: All Next.js API routes had hardcoded fallback URLs

**Files Changed**:
- `apps/web/app/api/crawl/route.ts:5`
- `apps/web/app/api/crawl/status/[jobId]/route.ts:5`
- `apps/web/app/api/crawl/[jobId]/route.ts:3`
- `apps/web/app/api/chat-rag/route.ts:9`
- `apps/web/app/api/scrape/route.ts:4`
- `apps/web/app/api/map/route.ts:4`
- `apps/web/app/api/stats/route.ts:6`
- `apps/web/app/api/conversations/[id]/route.ts:11`
- `apps/web/app/api/conversations/route.ts:10`
- `apps/web/app/api/extract/route.ts:4`
- `apps/web/app/api/search/route.ts:4`
- `apps/web/lib/firecrawl-tools.ts:5`

**Change Pattern**:
```typescript
// Before:
const backendUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

// After:
const backendUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4400';
```

#### 4. Scripts
**File**: `kill-ports.sh:2,4,6`
```bash
# Before: ports 3000, 3001, 8000
# After: ports 4300, 4301, 4400

for port in 4300 4301 4400; do
```

#### 5. Environment Files
**Files Updated**:
- `.env.example:28-29,37` - API_PORT and WEBHOOK_BASE_URL comments
- `.env` - Added WEBHOOK_BASE_URL=http://localhost:4400
- `apps/api/.env.example:27-29,33` - Webhook and API port
- `apps/api/.env` - Added WEBHOOK_BASE_URL

#### 6. Tests
**File**: `apps/api/tests/conftest.py:259`
```python
# Updated test fixture
monkeypatch.setenv("WEBHOOK_BASE_URL", "http://test:4400")  # was 8000
```

#### 7. Documentation (26 files)

**Core Docs**:
- `CLAUDE.md:23,45,52,250` - Build commands, ports
- `AGENTS.md:23,43,50,227` - Build commands, ports  
- `README.md:108,127,163,174,281-282` - Usage examples
- `apps/web/README.md:17` - localhost URL
- `apps/api/README.md:40` - uvicorn command
- `apps/web/CLAUDE.md:114,376,490` - Examples, CORS notes
- `apps/api/CLAUDE.md:122,234,407-408,417-418` - Config, CORS

**Historical Docs** (used sed for bulk update):
- `.docs/tmp/environment-config-cleanup.md`
- `.docs/tmp/firecrawl-tools-and-ui-improvements.md`
- `.docs/tmp/stats-implementation.md`
- `.docs/tmp/tool-badge-redesign-investigation.md`
- `.docs/tmp/tool-call-badge-enhancements.md`
- `docs/PHASE_0_COMPLETE.md`
- `docs/PHASE_1_COMPLETE.md`
- `docs/implementation/RESEARCH_FINDINGS.md`

## Verification

### Search Results (Post-Migration)
```bash
# Check for remaining old port references
grep -r "localhost:3000\|localhost:8000" \
  --include="*.py" --include="*.ts" --include="*.tsx" \
  --include="*.md" --include="*.sh" --include="*.json" \
  --exclude-dir=node_modules --exclude-dir=.next \
  2>/dev/null | wc -l

# Result: 0 ✅
```

### Git Stats
```
61 files changed
680 insertions(+)
361 deletions(-)
60 old port references removed
```

### Critical Files Verified
```bash
# Backend port
apps/api/app/main.py:64 → port=4400 ✅

# Frontend port  
apps/web/package.json:6 → "dev": "next dev -p 4300" ✅

# CORS origins
apps/api/app/core/config.py:26-29 → localhost:4300, 10.1.0.6:4300 ✅

# Kill script
kill-ports.sh:6 → for port in 4300 4301 4400 ✅

# API routes (sample)
apps/web/app/api/crawl/route.ts:5 → localhost:4400 ✅
```

## Implementation Method

1. **Research Phase**: Used `Grep` to find all occurrences
2. **Configuration Phase**: Updated core config files (main.py, config.py, package.json)
3. **Environment Phase**: Updated all .env and .env.example files
4. **API Routes Phase**: Updated 12 Next.js API route files with fallback URLs
5. **Scripts Phase**: Updated kill-ports.sh
6. **Documentation Phase**: 
   - Core docs: Manual MultiEdit for precision
   - Historical docs: Bulk sed replace for efficiency
7. **Verification Phase**: grep search confirmed 0 remaining references

## Testing Checklist

- [ ] Run `npm run kill-ports` - should clear 4300, 4301, 4400
- [ ] Run `npm run dev` - backend→4400, frontend→4300
- [ ] Visit `http://localhost:4300` - frontend loads
- [ ] Test `curl http://localhost:4400/health` - backend responds
- [ ] Initiate crawl from UI - CORS allows origin
- [ ] Check webhook callbacks use port 4400

## Notes

- **No breaking changes** in logic, only port numbers changed
- **CORS configuration** automatically allows new frontend port
- **All fallback URLs** updated to prevent environment variable misconfigurations
- **Documentation sync** ensures developers see correct ports everywhere
